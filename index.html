<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpsons Cluedo - 2¬∫ ESO Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { 
            --bg-color: #0b0b0b; 
            --text-color: #fff; 
            --accent-color: #ffd90f; 
            --panel-bg: #1a1a1a; 
            --border-color: #444;
            /* Map Colors from Image */
            --grass: #56a55c;
            --hallway: #ebae4d;
            --room: #d1d1d1;
            --wall: #4b3621;
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', 'Arial', sans-serif; }
        
        /* Layout */
        #game-container { display: none; width: 100vw; height: 100vh; flex-direction: row; }
        #board-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #222; position: relative; overflow: hidden; }
        
        #board-wrapper { 
            position: relative; 
            width: 85vh; 
            aspect-ratio: 24 / 25; 
            background: var(--grass); 
            border: 8px solid #333;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }
        
        #grid-overlay { 
            display: grid; 
            grid-template-columns: repeat(24, 1fr); 
            grid-template-rows: repeat(25, 1fr); 
            width: 100%; height: 100%; position: absolute; top:0; left:0;
        }

        /* Map Styling */
        .cell { box-sizing: border-box; position: relative; }
        
        /* Hallway Tile Effect */
        .cell.hallway { 
            background-color: var(--hallway); 
            border: 1px solid rgba(0,0,0,0.15); 
            cursor: pointer;
        }
        .cell.hallway:hover { background-color: #f3c171; }

        /* Room Styling */
        .cell.room { background-color: var(--room); border: 0.2px solid #aaa; }
        .cell.wall-n { border-top: 4px solid var(--wall); }
        .cell.wall-s { border-bottom: 4px solid var(--wall); }
        .cell.wall-e { border-right: 4px solid var(--wall); }
        .cell.wall-w { border-left: 4px solid var(--wall); }

        .room-label {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 0.6rem;
            color: #555;
            font-weight: bold;
            pointer-events: none;
            z-index: 5;
            text-transform: uppercase;
            top: 50%; transform: translateY(-50%);
        }

        /* Circular Tokens */
        .player-domino { 
            position: absolute; 
            width: 4.5%; 
            height: 4.5%; 
            transform: translate(-50%, -50%); 
            transition: all 0.5s ease; 
            z-index: 100; 
            border-radius: 50%; 
            border: 2px solid white;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: 1000; color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* Sidebar Styling */
        #ui-sidebar { width: 340px; background: var(--panel-bg); border-left: 2px solid var(--border-color); padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .section { background: #111; padding: 12px; border-radius: 8px; border: 1px solid #333; }
        .status-bar { background: var(--accent-color); color: #000; padding: 10px; font-weight: bold; text-align: center; border-radius: 5px; margin-bottom: 5px; }
        
        #game-log { flex-grow: 1; overflow-y: auto; font-size: 0.7rem; background: #000; padding: 10px; border-radius: 5px; font-family: monospace; color: #aaa; }
        
        button { padding: 10px; background: var(--accent-color); border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; width: 100%; margin-top: 5px;}
        button:hover { background: #fff1a0; }
        button:disabled { background: #444; color: #777; cursor: not-allowed; }

        select { width: 100%; padding: 8px; background: #222; color: white; border: 1px solid #444; border-radius: 4px; margin-bottom: 5px; }

        /* Lobby */
        #lobby { position: fixed; inset: 0; background: #000; z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #lobby input { padding: 12px; margin-bottom: 10px; background: #222; border: 1px solid var(--accent-color); color: white; border-radius: 5px; text-align: center;}
    </style>
</head>
<body>

<div id="lobby">
    <h1 style="color:var(--accent-color); letter-spacing: 2px;">SIMPSONS CLUEDO</h1>
    <input type="text" id="room-input" placeholder="ENTER ROOM NAME">
    <button style="width: 200px;" onclick="joinRoom()">JOIN GAME</button>
    <div id="char-selection" style="margin-top:20px; display:none; text-align: center;">
        <p>CHOOSE YOUR CHARACTER:</p>
        <div id="char-btns"></div>
    </div>
</div>

<div id="game-container">
    <div id="board-area">
        <div id="board-wrapper">
            <div id="grid-overlay"></div>
        </div>
    </div>

    <div id="ui-sidebar">
        <div id="location-bar" class="status-bar">LOC: LOADING...</div>
        <div id="turn-info" style="text-align:center; font-weight:bold; color: var(--accent-color); font-size: 0.9rem;">WAITING...</div>
        
        <div class="section">
            <div id="dice-box" style="text-align:center; font-size:2.5rem; margin-bottom: 10px;">
                <span id="d1">‚öÄ</span> <span id="d2">‚öÄ</span>
            </div>
            <button id="roll-btn" onclick="rollDice()">ROLL DICE</button>
        </div>

        <div class="section">
            <select id="s-suspect"></select>
            <select id="s-weapon"></select>
            <button id="suggest-btn" onclick="handleSuggestion()">SUGGESTION</button>
            <button id="accuse-btn" style="background: #e74c3c; color: white;" onclick="handleAccusation()">FINAL ACCUSATION</button>
        </div>

        <div id="game-log"></div>
    </div>
</div>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
        apiKey: "AIzaSyCxN2d4RZyt9Q5JOKZxT7pJ5NBirAoxEn4",
        databaseURL: "https://cluedo-821bd-default-rtdb.firebaseio.com",
        projectId: "cluedo-821bd",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- GAME DATA ---
    const suspects = ["Homer", "Moe", "Duffman", "Mr Burns", "Krusty", "Smithers"];
    const weapons = ["Poisoned Donut", "Saxophone", "Knife", "Gun", "Candelabrum", "Book"];
    const characters = [
        { name: "Homer", color: "#ffd90f", startX: 2, startY: 2, icon: "H" },
        { name: "Moe", color: "#4dabf7", startX: 11, startY: 2, icon: "M" },
        { name: "Duffman", color: "#ff6b6b", startX: 21, startY: 2, icon: "D" },
        { name: "Mr Burns", color: "#51cf66", startX: 2, startY: 12, icon: "B" }
    ];

    // Room Layout (Matching your image)
    const roomZones = [
        { name: "Cafeteria", x1: 0, y1: 0, x2: 3, y2: 6 },
        { name: "Lab", x1: 10, y1: 0, x2: 13, y2: 6 },
        { name: "Art's Class", x1: 18, y1: 0, x2: 23, y2: 7 },
        { name: "Teacher Lounge", x1: 2, y1: 8, x2: 9, y2: 16 },
        { name: "ICT Room", x1: 11, y1: 9, x2: 15, y2: 14 },
        { name: "Gym", x1: 16, y1: 9, x2: 20, y2: 15 },
        { name: "Annex", x1: 21, y1: 9, x2: 23, y2: 24 },
        { name: "Library", x1: 5, y1: 18, x2: 10, y2: 24 },
        { name: "English Dept", x1: 11, y1: 18, x2: 15, y2: 24 },
        { name: "Hall", x1: 16, y1: 18, x2: 20, y2: 24 }
    ];

    let roomPath, myName, localState, movesLeft = 0;

    // --- RENDERING MAP ---
    function isHallway(x, y) {
        // Main corridors based on the yellow path in your image
        if (y >= 7 && y <= 8 && x >= 4) return true;
        if (y >= 15 && y <= 17 && x >= 4 && x <= 20) return true;
        if (x >= 10 && x <= 11 && y >= 7 && y <= 17) return true;
        if (x >= 15 && x <= 16 && y >= 7 && y <= 20) return true;
        if (x <= 4 && y >= 7 && y <= 8) return true;
        return false;
    }

    function renderBoard() {
        const grid = document.getElementById('grid-overlay');
        grid.innerHTML = '';
        
        for (let y = 0; y < 25; y++) {
            for (let x = 0; x < 24; x++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                
                const room = roomZones.find(r => x >= r.x1 && x <= r.x2 && y >= r.y1 && y <= r.y2);
                
                if (room) {
                    cell.classList.add('room');
                    if (y === room.y1) cell.classList.add('wall-n');
                    if (y === room.y2) cell.classList.add('wall-s');
                    if (x === room.x1) cell.classList.add('wall-w');
                    if (x === room.x2) cell.classList.add('wall-e');
                    
                    // Add Room Names at center of room
                    if (x === Math.floor((room.x1 + room.x2)/2) && y === Math.floor((room.y1 + room.y2)/2)) {
                        const label = document.createElement('div');
                        label.className = 'room-label';
                        label.textContent = room.name;
                        cell.appendChild(label);
                    }
                } else if (isHallway(x, y)) {
                    cell.classList.add('hallway');
                    cell.onclick = () => movePlayer(x, y);
                }
                grid.appendChild(cell);
            }
        }
    }

    // --- LOBBY & JOIN ---
    function joinRoom() {
        const id = document.getElementById('room-input').value;
        if(!id) return alert("Enter a room name!");
        roomPath = 'cluedo/' + id;
        document.getElementById('char-selection').style.display = 'block';
        
        db.ref(roomPath).on('value', snap => {
            localState = snap.val() || {};
            updateUI();
        });

        const container = document.getElementById('char-btns');
        container.innerHTML = "";
        characters.forEach(c => {
            const b = document.createElement('button');
            b.textContent = c.name;
            b.style.background = c.color;
            b.style.margin = "5px"; b.style.width = "120px";
            b.onclick = () => selectChar(c.name);
            container.appendChild(b);
        });
    }

    function selectChar(name) {
        myName = name;
        db.ref(roomPath + '/players/' + name).set({ name, active: true });
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        if(!localState.started) checkStart();
        
        // Populate Selects
        const sS = document.getElementById('s-suspect');
        const sW = document.getElementById('s-weapon');
        suspects.forEach(s => sS.innerHTML += `<option>${s}</option>`);
        weapons.forEach(w => sW.innerHTML += `<option>${w}</option>`);
    }

    function checkStart() {
        const pCount = Object.keys(localState.players || {}).length;
        if(pCount >= 2 && !localState.started) {
            const sol = { s: suspects[0], w: weapons[0], r: roomZones[0].name };
            db.ref(roomPath).update({
                started: true, turn: 0, solution: sol,
                positions: characters.reduce((a, v) => ({...a, [v.name]: {x: v.startX, y: v.startY}}), {}),
                logs: ["Game Started! Good luck."]
            });
        }
    }

    // --- CORE GAMEPLAY ---
    function updateUI() {
        if(!localState.started) return;
        renderBoard();

        // Render Tokens
        const wrapper = document.getElementById('board-wrapper');
        document.querySelectorAll('.player-domino').forEach(d => d.remove());
        
        Object.keys(localState.positions).forEach(p => {
            const pos = localState.positions[p];
            const charData = characters.find(c => c.name === p);
            const dom = document.createElement('div');
            dom.className = 'player-domino';
            dom.style.left = (pos.x * (100/24) + (100/48)) + "%";
            dom.style.top = (pos.y * (100/25) + (100/50)) + "%";
            dom.style.backgroundColor = charData.color;
            dom.textContent = charData.icon;
            wrapper.appendChild(dom);
        });

        const players = Object.keys(localState.players);
        const isMyTurn = players[localState.turn] === myName;
        document.getElementById('turn-info').textContent = isMyTurn ? "YOUR TURN" : `WAITING FOR ${players[localState.turn].toUpperCase()}`;
        document.getElementById('roll-btn').disabled = !isMyTurn || movesLeft > 0;

        const myPos = localState.positions[myName];
        const currentRoom = roomZones.find(z => myPos.x >= z.x1 && myPos.x <= z.x2 && myPos.y >= z.y1 && myPos.y <= z.y2);
        document.getElementById('location-bar').textContent = "LOC: " + (currentRoom ? currentRoom.name : "HALLWAY");
        
        document.getElementById('game-log').innerHTML = (localState.logs || []).slice().reverse().map(l => `<div>> ${l}</div>`).join('');
    }

    function rollDice() {
        const r1 = Math.floor(Math.random()*6)+1;
        const r2 = Math.floor(Math.random()*6)+1;
        movesLeft = r1 + r2;
        document.getElementById('d1').textContent = ['','‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][r1];
        document.getElementById('d2').textContent = ['','‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][r2];
        addLog(`${myName} rolled a ${movesLeft}`);
    }

    function movePlayer(x, y) {
        if (movesLeft <= 0) return;
        const currentPos = localState.positions[myName];
        const dist = Math.abs(currentPos.x - x) + Math.abs(currentPos.y - y);
        
        if (dist <= movesLeft) {
            db.ref(roomPath + '/positions/' + myName).set({x, y});
            movesLeft = 0;
            nextTurn();
        } else {
            alert("Too far!");
        }
    }

    function nextTurn() {
        const next = (localState.turn + 1) % Object.keys(localState.players).length;
        db.ref(roomPath + '/turn').set(next);
    }

    function addLog(m) {
        const logs = localState.logs || [];
        logs.push(m);
        if(logs.length > 15) logs.shift();
        db.ref(roomPath + '/logs').set(logs);
    }

    function handleSuggestion() {
        const s = document.getElementById('s-suspect').value;
        const w = document.getElementById('s-weapon').value;
        addLog(`üïµÔ∏è ${myName} suggests: ${s} with ${w}`);
        nextTurn();
    }

    function handleAccusation() {
        const s = document.getElementById('s-suspect').value;
        addLog(`üõë ${myName} made an accusation! Check terminal.`);
        nextTurn();
    }

    window.onload = renderBoard;
</script>
</body>
</html>






