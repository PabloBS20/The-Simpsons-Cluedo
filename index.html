<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpsons Cluedo - 2¬∫ ESO Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --bg-color: #0b0b0b; --text-color: #fff; --accent-color: #ffd90f; --panel-bg: #1a1a1a; --border-color: #444; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', sans-serif; }
        
        /* Layout */
        #game-container { display: none; width: 80vw; height: 80vh; flex-direction: row; }
        #board-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #222; position: relative; overflow: hidden; }
        #board-wrapper { position: relative; width: 95%; aspect-ratio: 24 / 25; background-image: url('tablero.jpg'); background-size: 100% 100%; border: 5px solid #444; }
        
        /* Grid */
        #grid-overlay { display: grid; grid-template-columns: repeat(24, 1fr); grid-template-rows: repeat(25, 1fr); width: 80%; height: 80%; position: absolute; z-index: 10; }
        .cell { border: 1px solid rgba(255, 255, 255, 0.03); cursor: pointer; }
        .cell:hover { background: rgba(255, 217, 15, 0.2); }

        /* Domino Tokens */
        .player-domino { 
            position: absolute; width: 3.8%; height: 6%; 
            transform: translate(-50%, -50%); transition: 0.5s; 
            z-index: 20; border-radius: 4px; border: 2px solid white;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.6rem; font-weight: bold; color: black; text-align: center;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
        }

        /* Sidebar & UI */
        #ui-sidebar { width: 360px; background: var(--panel-bg); border-left: 2px solid var(--border-color); padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .section { background: #111; padding: 12px; border-radius: 8px; border: 1px solid #333; }
        .status-bar { background: #ffd90f; color: #000; padding: 10px; font-weight: bold; text-align: center; border-radius: 5px; margin-bottom: 10px; }
        
        /* Dice */
        #dice-box { display: flex; justify-content: center; gap: 15px; font-size: 3rem; margin: 10px 0; color: var(--accent-color); }
        .die { transition: 0.1s; }

        /* Notebook */
        .notepad-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.75rem; }
        .cat-title { grid-column: span 2; color: var(--accent-color); font-size: 0.7rem; text-transform: uppercase; margin-top: 8px; border-bottom: 1px solid #333; }
        
        /* Modal for showing cards */
        #disprove-modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
        }
        .card-btn { padding: 15px; margin: 10px; background: #ffd90f; color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Lobby */
        #lobby { position: fixed; inset: 0; background: #000; z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        button { padding: 10px 20px; background: var(--accent-color); border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #555; }
    </style>
</head>
<body>

<div id="lobby">
    <h1 style="color:var(--accent-color)">SIMPSONS CLUEDO 2¬∫ ESO</h1>
    <input type="text" id="room-input" placeholder="Room Name" style="padding:10px; margin-bottom:10px;">
    <button onclick="joinRoom()">JOIN ROOM</button>
    <div id="char-selection" style="margin-top:20px; display:none;">
        <p>Pick your character:</p>
        <div id="char-btns"></div>
    </div>
</div>

<div id="disprove-modal">
    <h2 id="disprove-msg">Show a card to disprove:</h2>
    <div id="disprove-options"></div>
</div>

<div id="game-container">
    <div id="board-area">
        <div id="board-wrapper">
            <div id="grid-overlay"></div>
        </div>
    </div>

    <div id="ui-sidebar">
        <div id="location-bar" class="status-bar">Location: Loading...</div>
        <div id="turn-info" style="text-align:center; font-weight:bold; color: #ffd90f;">Waiting for players...</div>
        
        <div class="section">
            <div id="dice-box"><span id="d1">‚öÄ</span><span id="d2">‚öÄ</span></div>
            <button id="roll-btn" style="width:100%" onclick="rollDice()">ROLL DICE</button>
        </div>

        <div class="section">
            <select id="s-suspect" style="width:100%; margin-bottom:5px;"></select>
            <select id="s-weapon" style="width:100%; margin-bottom:10px;"></select>
            <button id="suggest-btn" style="width:100%" onclick="handleSuggestion()">SUGGEST</button>
        </div>

        <div class="section">
            <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">MY CARDS:</div>
            <div id="my-hand"></div>
        </div>

        <div class="section" style="flex-grow:1">
            <div class="notepad-grid" id="notebook"></div>
        </div>

        <button style="background:#e74c3c; color:white;" onclick="handleAccusation()">FINAL ACCUSATION</button>
        <div id="game-log" style="height:100px; overflow-y:auto; font-size:0.7rem; background:#000; padding:5px; margin-top:5px; font-family:monospace;"></div>
    </div>
</div>

<script>
    // --- DATABASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCxN2d4RZyt9Q5JOKZxT7pJ5NBirAoxEn4",
        databaseURL: "https://cluedo-821bd-default-rtdb.firebaseio.com",
        projectId: "cluedo-821bd",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- DATA ---
    const suspects = ["Homer", "Moe", "Duffman", "Mr Burns", "Krusty", "Smithers"];
    const weapons = ["Poisoned Donut", "Saxophone", "Knife", "Gun", "Candelabrum", "Book"];
    const rooms = ["Cafeteria", "Lab", "Art's class", "2¬∫A", "Teacher's lounge", "ICT room", "Gym", "Library", "English department", "Hall", "Bathroom", "Cinema room", "Annex"];
    const characters = [
        { name: "Homer", color: "#ffd90f", x: 2, y: 2 },
        { name: "Moe", color: "#4dabf7", x: 11, y: 3 },
        { name: "Duffman", color: "#ff6b6b", x: 20, y: 2 },
        { name: "Mr Burns", color: "#51cf66", x: 3, y: 12 }
    ];
    const roomZones = [
        { name: "Cafeteria", x1: 0, y1: 0, x2: 4, y2: 6 },
        { name: "Lab", x1: 6, y1: 0, x2: 11, y2: 5 },
        { name: "Art's class", x1: 13, y1: 0, x2: 17, y2: 5 },
        { name: "2¬∫A", x1: 19, y1: 0, x2: 23, y2: 6 },
        { name: "Teacher's lounge", x1: 0, y1: 8, x2: 7, y2: 16 },
        { name: "ICT room", x1: 13, y1: 8, x2: 17, y2: 14 },
        { name: "Gym", x1: 19, y1: 9, x2: 23, y2: 15 },
        { name: "Library", x1: 0, y1: 18, x2: 4, y2: 24 },
        { name: "English department", x1: 6, y1: 18, x2: 12, y2: 24 },
        { name: "Hall", x1: 14, y1: 17, x2: 23, y2: 24 },
        { name: "Bathroom", x1: 15, y1: 9, x2: 17, y2: 12 },
        { name: "Cinema room", x1: 9, y1: 8, x2: 11, y2: 12 },
        { name: "Annex", x1: 21, y1: 10, x2: 23, y2: 14 }
    ];

    let roomPath, myName, localState, movesLeft = 0;

    // --- LOBBY LOGIC ---
    function joinRoom() {
        const id = document.getElementById('room-input').value;
        if(!id) return;
        roomPath = 'cluedo/' + id;
        document.getElementById('char-selection').style.display = 'block';
        db.ref(roomPath).on('value', snap => {
            localState = snap.val() || {};
            updateUI();
        });
        renderLobbyBtns();
    }

    function renderLobbyBtns() {
        const container = document.getElementById('char-btns');
        container.innerHTML = "";
        characters.forEach(c => {
            const b = document.createElement('button');
            b.textContent = c.name; b.style.margin = "5px";
            b.onclick = () => selectChar(c.name);
            container.appendChild(b);
        });
    }

    function selectChar(name) {
        myName = name;
        db.ref(roomPath + '/players/' + name).set({ name, active: true });
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        initNotebook();
        if(!localState.started) checkStart();
    }

    function checkStart() {
        const pCount = Object.keys(localState.players || {}).length;
        if(pCount >= 2 && !localState.started) {
            const deck = [...suspects, ...weapons, ...rooms];
            const sol = { s: suspects[Math.floor(Math.random()*6)], w: weapons[Math.floor(Math.random()*6)], r: rooms[Math.floor(Math.random()*13)] };
            const mainDeck = deck.filter(c => c !== sol.s && c !== sol.w && c !== sol.r).sort(() => Math.random() - 0.5);
            
            let hands = {};
            Object.keys(localState.players).forEach((p, i) => {
                hands[p] = mainDeck.filter((_, idx) => idx % pCount === i);
            });

            db.ref(roomPath).update({
                started: true, turn: 0, solution: sol, hands,
                positions: characters.reduce((a, v) => ({...a, [v.name]: {x: v.x, y: v.y}}), {}),
                logs: ["Game Started!"]
            });
        }
    }

    // --- GAMEPLAY ---
    function updateUI() {
        if(!localState.started) return;
        
        // 1. Update Grid/Tokens
        const wrapper = document.getElementById('board-wrapper');
        document.querySelectorAll('.player-domino').forEach(d => d.remove());
        Object.keys(localState.positions).forEach(p => {
            const pos = localState.positions[p];
            const dom = document.createElement('div');
            dom.className = 'player-domino';
            dom.style.left = (pos.x * (100/24) + 2) + "%";
            dom.style.top = (pos.y * (100/25) + 3) + "%";
            dom.style.backgroundColor = characters.find(c => c.name === p).color;
            dom.textContent = p;
            wrapper.appendChild(dom);
        });

        // 2. Turn Logic
        const playerOrder = Object.keys(localState.players);
        const activeChar = playerOrder[localState.turn];
        const isMyTurn = activeChar === myName;
        document.getElementById('turn-info').textContent = isMyTurn ? "IT IS YOUR TURN!" : `Waiting for ${activeChar}...`;
        document.getElementById('roll-btn').disabled = !isMyTurn || movesLeft > 0;
        
        // 3. Room Detection & Suggestion Enforcing
        const myPos = localState.positions[myName];
        const currentRoom = roomZones.find(z => myPos.x >= z.x1 && myPos.x <= z.x2 && myPos.y >= z.y1 && myPos.y <= z.y2);
        document.getElementById('location-bar').textContent = "Location: " + (currentRoom ? currentRoom.name : "Hallway");
        document.getElementById('suggest-btn').disabled = !isMyTurn || !currentRoom;

        // 4. Disprove Mechanic logic
        if(localState.pendingDisprove && localState.pendingDisprove.to === myName) {
            showDisproveModal(localState.pendingDisprove);
        }

        // 5. Populate lists once
        if(document.getElementById('s-suspect').options.length === 0) {
            suspects.forEach(s => document.getElementById('s-suspect').innerHTML += `<option>${s}</option>`);
            weapons.forEach(w => document.getElementById('s-weapon').innerHTML += `<option>${w}</option>`);
        }
        
        document.getElementById('my-hand').innerHTML = localState.hands[myName].map(c => `<span style="font-size:0.7rem; background:#333; padding:2px 5px; margin:2px; border-radius:3px;">${c}</span>`).join(' ');
        document.getElementById('game-log').innerHTML = (localState.logs || []).slice().reverse().map(l => `<div>> ${l}</div>`).join('');
    }

    function rollDice() {
        const r1 = Math.floor(Math.random()*6)+1;
        const r2 = Math.floor(Math.random()*6)+1;
        movesLeft = r1 + r2;
        document.getElementById('d1').textContent = ['','‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][r1];
        document.getElementById('d2').textContent = ['','‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][r2];
        addLog(`${myName} rolled a ${movesLeft}`);
        renderGrid();
    }

    function renderGrid() {
        const g = document.getElementById('grid-overlay');
        g.innerHTML = "";
        for(let i=0; i<24*25; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            const x = i%24; const y = Math.floor(i/24);
            cell.onclick = () => movePlayer(x, y);
            g.appendChild(cell);
        }
    }

    function movePlayer(x, y) {
        if(movesLeft <= 0) return;
        const pos = localState.positions[myName];
        const dist = Math.abs(pos.x - x) + Math.abs(pos.y - y);
        if(dist <= movesLeft) {
            db.ref(roomPath + '/positions/' + myName).set({x, y});
            movesLeft = 0;
            document.getElementById('grid-overlay').innerHTML = "";
        }
    }

    // --- SUGGESTION & DISPROVE LOGIC ---
    function handleSuggestion() {
        const s = document.getElementById('s-suspect').value;
        const w = document.getElementById('s-weapon').value;
        const r = roomZones.find(z => {
            const p = localState.positions[myName];
            return p.x >= z.x1 && p.x <= z.x2 && p.y >= z.y1 && p.y <= z.y2;
        }).name;

        addLog(`üïµÔ∏è ${myName} suggests: ${s} in ${r} with ${w}`);
        
        // Find next player to disprove
        const players = Object.keys(localState.players);
        const myIdx = players.indexOf(myName);
        const nextIdx = (myIdx + 1) % players.length;
        const nextPlayer = players[nextIdx];

        db.ref(roomPath + '/pendingDisprove').set({
            from: myName,
            to: nextPlayer,
            cards: [s, w, r]
        });
    }

    function showDisproveModal(data) {
        const modal = document.getElementById('disprove-modal');
        const options = document.getElementById('disprove-options');
        const myCards = localState.hands[myName];
        const matches = myCards.filter(c => data.cards.includes(c));

        modal.style.display = 'flex';
        options.innerHTML = "";

        if(matches.length === 0) {
            const b = document.createElement('button');
            b.className = 'card-btn'; b.textContent = "I cannot disprove";
            b.onclick = () => passDisprove(data);
            options.appendChild(b);
        } else {
            matches.forEach(m => {
                const b = document.createElement('button');
                b.className = 'card-btn'; b.textContent = "Show " + m;
                b.onclick = () => sendDisprove(m, data.from);
                options.appendChild(b);
            });
        }
    }

    function sendDisprove(card, toPlayer) {
        addLog(`${myName} showed a card to ${toPlayer}`);
        db.ref(roomPath + '/pendingDisprove').remove();
        document.getElementById('disprove-modal').style.display = 'none';
        
        if(toPlayer === myName) return; // Shouldnt happen
        // Automatically check it in their notebook via log or alert
        alert(`You showed the ${card} card to ${toPlayer}`);
        // Increment turn
        nextTurn();
    }

    function passDisprove(data) {
        const players = Object.keys(localState.players);
        const currentToIdx = players.indexOf(myName);
        const nextToIdx = (currentToIdx + 1) % players.length;
        const nextPlayer = players[nextToIdx];

        if(nextPlayer === data.from) {
            addLog(`Nobody could disprove the suggestion!`);
            db.ref(roomPath + '/pendingDisprove').remove();
            document.getElementById('disprove-modal').style.display = 'none';
            nextTurn();
        } else {
            db.ref(roomPath + '/pendingDisprove/to').set(nextPlayer);
            document.getElementById('disprove-modal').style.display = 'none';
        }
    }

    function nextTurn() {
        const next = (localState.turn + 1) % Object.keys(localState.players).length;
        db.ref(roomPath + '/turn').set(next);
    }

    function addLog(m) {
        const logs = localState.logs || [];
        logs.push(m);
        if(logs.length > 20) logs.shift();
        db.ref(roomPath + '/logs').set(logs);
    }

    function initNotebook() {
        const nb = document.getElementById('notebook');
        const items = [
            {t: "Suspects", i: suspects}, {t: "Weapons", i: weapons}, {t: "Rooms", i: rooms}
        ];
        items.forEach(cat => {
            nb.innerHTML += `<div class="cat-title">${cat.t}</div>`;
            cat.i.forEach(item => {
                nb.innerHTML += `<div><input type="checkbox"> ${item}</div>`;
            });
        });
    }

    function handleAccusation() {
        const s = document.getElementById('s-suspect').value;
        const w = document.getElementById('s-weapon').value;
        const r = document.getElementById('location-bar').textContent.split(': ')[1];
        if(r === "Hallway") return alert("Must be in a room to accuse!");

        if(s === localState.solution.s && w === localState.solution.w && r === localState.solution.r) {
            addLog(`üèÜ ${myName} WON! It was ${s} in the ${r} with the ${w}!`);
            db.ref(roomPath + '/started').set(false);
        } else {
            addLog(`‚ùå ${myName} accused wrongly and is OUT!`);
            nextTurn();
        }
    }
</script>
</body>
</html>





