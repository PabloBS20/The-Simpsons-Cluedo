<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpsons Cluedo Online</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --bg-color: #000; --text-color: #fff; --accent-color: #ffd90f; --panel-bg: #1a1a1a; --border-color: #444; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg-color); color: var(--text-color); font-family: sans-serif; }
        
        /* Lobby Styles */
        #lobby-screen { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
        input { padding: 12px; border-radius: 5px; border: none; width: 250px; font-size: 1rem; }
        
        /* Game Styles */
        #game-container { display: none; width: 100vw; height: 100vh; }
        #board-wrapper { position: relative; flex-grow: 1; background-image: url('tablero.jpg'); background-size: 100% 100%; }
        #grid-overlay { display: grid; grid-template-columns: repeat(24, 1fr); grid-template-rows: repeat(25, 1fr); width: 100%; height: 100%; position: absolute; }
        .cell { border: 0.1px solid rgba(255,255,255,0.05); cursor: pointer; }
        
        #ui-sidebar { width: 350px; background: var(--panel-bg); border-left: 2px solid var(--border-color); padding: 15px; overflow-y: auto; }
        .section { background: #111; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
        .player-token { width: 40px; height: 40px; position: absolute; transform: translate(-50%, -50%); transition: 0.4s; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 10px rgba(0,0,0,0.8); }
        .eliminated { opacity: 0.3; filter: grayscale(1); }
        
        button { padding: 10px; background: var(--accent-color); border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: #000; }
        button:disabled { background: #555; cursor: not-allowed; color: #888; }
        .card { background: #333; padding: 5px 10px; border-radius: 4px; border: 1px solid #555; font-size: 0.8em; margin: 2px; display: inline-block; }
        #log { height: 100px; background: #000; overflow-y: auto; font-size: 0.8em; padding: 5px; border: 1px solid #333; color: #0f0; font-family: monospace; }

        /* Notebook Styles */
        .notepad-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.85em; }
        .notepad-item { display: flex; align-items: center; gap: 8px; padding: 3px; cursor: pointer; }
        .notepad-item input { width: 15px; height: 15px; cursor: pointer; }
        .notepad-item input:checked + label { text-decoration: line-through; color: #888; }
        .notepad-category { grid-column: span 2; color: var(--accent-color); border-bottom: 1px solid #444; margin-top: 10px; font-size: 0.9em; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <h1 style="color:var(--accent-color);">SIMPSONS CLUEDO ONLINE</h1>
        <div id="setup-step">
            <input type="text" id="room-id" placeholder="Enter Class Code (2A)">
            <button onclick="joinRoom()">Enter Room</button>
        </div>
        <div id="char-step" style="display:none;">
            <h3>Pick your character:</h3>
            <div id="char-btns" class="btn-group"></div>
            <p id="wait-msg" style="margin-top:20px;"></p>
            <button onclick="db.ref(roomPath).remove(); location.reload();" style="background:#e74c3c; color:white; margin-top:30px; font-size:10px;">Teacher: Reset Room</button>
        </div>
    </div>

    <div id="game-container">
        <div id="board-wrapper"><div id="grid-overlay"></div></div>
        <div id="ui-sidebar">
            <h2 id="turn-indicator">Waiting...</h2>
            <div class="section">
                <h3>Movement</h3>
                <div id="dice-val" style="font-size: 2em; text-align: center;">?</div>
                <button id="roll-btn" onclick="rollDice()" style="width:100%">Roll Dice</button>
            </div>
            <div class="section">
                <h3>Suggestion</h3>
                <select id="guess-suspect" style="width:100%; margin-bottom:5px;"></select>
                <select id="guess-weapon" style="width:100%; margin-bottom:5px;"></select>
                <button id="suggest-btn" onclick="makeSuggestion()" style="width:100%">Make Suggestion</button>
            </div>
            <div class="section">
                <h3>Detective Notebook</h3>
                <div id="notebook-container" class="notepad-grid"></div>
            </div>
            <div class="section">
                <h3>Your Private Hand</h3>
                <div id="my-hand"></div>
            </div>
            <div class="section">
                <button style="background:red; color:white; width:100%" onclick="makeAccusation()">FINAL ACCUSATION</button>
                <button onclick="endTurn()" style="background:#444; color:white; margin-top:5px; width:100%">End Turn</button>
            </div>
            <div id="log"></div>
        </div>
    </div>

<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCxN2d4RZyt9Q5JOKZxT7pJ5NBirAoxEn4",
        databaseURL: "https://cluedo-821bd-default-rtdb.firebaseio.com",
        projectId: "cluedo-821bd",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

   // --- 2. GAME CONSTANTS ---
    const characters = [
        { name: "Homer", color: "#ffd90f", startX: 2, startY: 2 },
        { name: "Moe", color: "#4dabf7", startX: 11, startY: 3 },
        { name: "Duffman", color: "#ff6b6b", startX: 20, startY: 2 },
        { name: "Mr Burns", color: "#51cf66", startX: 3, startY: 12 } // <-- Removed the period here
    ];

    const gameData = {
        suspects: ["Homer", "Moe", "Duffman", "Mr Burns", "Krusty", "Smithers"], // <-- Removed the period here
        weapons: ["Poisoned Donut", "Saxophone", "Knife", "Gun", "Candelabrum", "Book"],
        rooms: ["Cafeteria", "Lab", "Art's class", "2ºA", "Teacher's lounge", "ICT room", "Gym", "Library", "English department", "Hall", "Bathroom", "Cinema room", "Annex"]
    };

    const roomZones = [
        { name: "Cafeteria", x1: 0, y1: 0, x2: 5, y2: 5 }, { name: "2ºA", x1: 8, y1: 0, x2: 15, y2: 6 },
        { name: "Teacher's lounge", x1: 18, y1: 0, x2: 23, y2: 5 }, { name: "ICT room", x1: 0, y1: 8, x2: 6, y2: 12 },
        { name: "Lab", x1: 0, y1: 14, x2: 6, y2: 17 }, { name: "Annex", x1: 10, y1: 14, x2: 14, y2: 17 }, 
        { name: "Gym", x1: 17, y1: 8, x2: 23, y2: 12 }, { name: "Library", x1: 17, y1: 14, x2: 23, y2: 18 },
        { name: "English department", x1: 0, y1: 19, x2: 6, y2: 24 }, { name: "Hall", x1: 9, y1: 19, x2: 14, y2: 24 },
        { name: "Bathroom", x1: 17, y1: 20, x2: 23, y2: 24 }, { name: "Art's class", x1: 7, y1: 9, x2: 10, y2: 12 },
        { name: "Cinema room", x1: 13, y1: 9, x2: 16, y2: 12 }
    ];

    // --- 3. STATE ---
    let roomPath = "";
    let myChar = "";
    let localState = {};
    let currentRoll = 0;
    let hasMovedThisTurn = false;

    // --- 4. JOIN LOGIC ---
    function joinRoom() {
        const id = document.getElementById('room-id').value;
        if (!id) return;
        updateStatus('connecting');
        roomPath = 'cluedo_rooms/' + id;
        document.getElementById('setup-step').style.display = 'none';
        document.getElementById('char-step').style.display = 'block';

        db.ref(".info/connected").on("value", (snap) => {
            updateStatus(snap.val() === true ? 'online' : 'offline');
        });

        db.ref(roomPath).on('value', (snap) => {
            localState = snap.val() || {};
            renderLobby();
            if (localState.started) startGameUI();
        });
    }

    function updateStatus(status) {
        let ind = document.getElementById('status-indicator');
        if (!ind) {
            ind = document.createElement('div');
            ind.id = 'status-indicator';
            ind.style = "position:fixed; top:10px; right:10px; padding:5px 10px; border-radius:20px; font-size:10px; font-weight:bold; z-index:4000; color:#000;";
            document.body.appendChild(ind);
        }
        ind.style.background = status === 'online' ? "#2ecc71" : status === 'connecting' ? "#f1c40f" : "#e74c3c";
        ind.textContent = status.toUpperCase();
    }

    function renderLobby() {
        const area = document.getElementById('char-btns');
        area.innerHTML = "";
        characters.forEach(c => {
            const btn = document.createElement('button');
            btn.textContent = c.name;
            btn.disabled = localState.players?.[c.name];
            btn.onclick = () => selectChar(c.name);
            area.appendChild(btn);
        });

        const playerCount = localState.players ? Object.keys(localState.players).length : 0;
        document.getElementById('wait-msg').textContent = `${playerCount}/4 players joined.`;
        
        if (playerCount >= 2 && !localState.started && myChar !== "") {
            const startBtn = document.createElement('button');
            startBtn.textContent = "HOST: START GAME";
            startBtn.style.background = "green";
            startBtn.style.color = "white";
            startBtn.onclick = hostInit;
            area.appendChild(startBtn);
        }
    }

    function selectChar(name) {
        myChar = name;
        db.ref(roomPath + '/players/' + name).set({ eliminated: false });
        document.getElementById('char-step').innerHTML = `<h3>You are ${name}.</h3><p>Waiting for host...</p>`;
    }

    // --- 5. HOST INITIALIZATION ---
    function hostInit() {
        // Create solution
        const solution = { suspect: "Smithers", weapon: "Book", room: "English department" };
        
        // Setup deck minus the solution cards
        let cards = [...gameData.suspects, ...gameData.weapons, ...gameData.rooms]
            .filter(c => c !== solution.suspect && c !== solution.weapon && c !== solution.room);
        
        // Shuffle deck
        cards.sort(() => Math.random() - 0.5);

        // Distribute cards evenly among ONLY the players who joined
        let hands = {};
        const activePlayers = Object.keys(localState.players);
        activePlayers.forEach(pName => hands[pName] = []);
        
        cards.forEach((card, idx) => {
            const pName = activePlayers[idx % activePlayers.length];
            hands[pName].push(card);
        });

        // Find the first player who actually joined to take the first turn
        let firstTurnIndex = 0;
        while (!localState.players[characters[firstTurnIndex].name]) {
            firstTurnIndex++;
        }

        db.ref(roomPath).update({
            started: true,
            turn: firstTurnIndex,
            solution: solution,
            hands: hands,
            positions: characters.reduce((acc, c) => { acc[c.name] = {x: c.startX, y: c.startY}; return acc; }, {}),
            logs: ["Game Started!"]
        });
    }

    // --- 6. GAMEPLAY ---
    function startGameUI() {
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        setupDropdowns();
        renderBoard();
        renderSidebar();
        renderNotebook();
    }

    function renderNotebook() {
        const container = document.getElementById('notebook-container');
        const categories = [{ title: "Suspects", items: gameData.suspects }, { title: "Weapons", items: gameData.weapons }, { title: "Rooms", items: gameData.rooms }];
        let html = "";
        categories.forEach(cat => {
            html += `<div class="notepad-category">${cat.title}</div>`;
            cat.items.forEach(item => {
                const storageKey = `note-${roomPath}-${myChar}-${item}`;
                const isChecked = localStorage.getItem(storageKey) === 'true' ? 'checked' : '';
                html += `<div class="notepad-item"><input type="checkbox" id="note-${item}" ${isChecked} onclick="localStorage.setItem('${storageKey}', this.checked)"><label for="note-${item}">${item}</label></div>`;
            });
        });
        container.innerHTML = html;
    }

    function renderBoard() {
        const grid = document.getElementById('grid-overlay');
        grid.innerHTML = "";
        for (let i = 0; i < 24 * 25; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            const x = i % 24; const y = Math.floor(i / 24);
            cell.onclick = () => handleMove(x, y);
            grid.appendChild(cell);
        }
        updateTokens();
    }

    function updateTokens() {
        document.querySelectorAll('.player-token').forEach(t => t.remove());
        characters.forEach(c => {
            const pos = localState.positions?.[c.name];
            if (!pos) return;
            const token = document.createElement('div');
            token.className = 'player-token' + (localState.players?.[c.name]?.eliminated ? ' eliminated' : '');
            token.style.left = `calc(${(pos.x + 0.5)} * (100% / 24))`;
            token.style.top = `calc(${(pos.y + 0.5)} * (100% / 25))`;
            token.style.background = c.color;
            document.getElementById('board-wrapper').appendChild(token);
        });
    }

    function renderSidebar() {
        if (localState.turn === undefined) return;
        const activePlayer = characters[localState.turn].name;
        const isMyTurn = activePlayer === myChar;
        document.getElementById('turn-indicator').textContent = isMyTurn ? "YOUR TURN" : `${activePlayer}'s Turn`;
        document.getElementById('roll-btn').disabled = !isMyTurn || hasMovedThisTurn;
        
        const myHand = localState.hands?.[myChar] || [];
        document.getElementById('my-hand').innerHTML = myHand.map(c => `<span class="card">${c}</span>`).join('');
        
        const log = document.getElementById('log');
        log.innerHTML = (localState.logs || []).slice().reverse().map(l => `<div>> ${l}</div>`).join('');
    }

    function rollDice() {
        currentRoll = (Math.floor(Math.random() * 6) + 1) + (Math.floor(Math.random() * 6) + 1);
        document.getElementById('dice-val').textContent = currentRoll;
        document.getElementById('roll-btn').disabled = true;
    }

    function handleMove(x, y) {
        if (currentRoll === 0 || characters[localState.turn].name !== myChar) return;
        const pos = localState.positions[myChar];
        const dist = Math.abs(pos.x - x) + Math.abs(pos.y - y);
        if (dist <= currentRoll) {
            db.ref(roomPath + '/positions/' + myChar).set({ x, y });
            addLog(`${myChar} moved.`);
            currentRoll = 0;
            hasMovedThisTurn = true;
        }
    }

    function makeSuggestion() {
        const pos = localState.positions[myChar];
        const r = roomZones.find(z => pos.x >= z.x1 && pos.x <= z.x2 && pos.y >= z.y1 && pos.y <= z.y2)?.name;
        if (!r) return alert("You must be in a room!");
        const s = document.getElementById('guess-suspect').value;
        const w = document.getElementById('guess-weapon').value;
        addLog(`${myChar} suggested ${s} with the ${w} in the ${r}.`);
    }

    function endTurn() {
        if (characters[localState.turn].name !== myChar) return;
        let next = (localState.turn + 1) % characters.length;
        
        // Skip players who didn't join OR are eliminated
        while (!localState.players?.[characters[next].name] || localState.players?.[characters[next].name]?.eliminated) {
            next = (next + 1) % characters.length;
        }
        
        db.ref(roomPath).update({ turn: next });
        hasMovedThisTurn = false;
        document.getElementById('dice-val').textContent = "?";
    }

    function addLog(msg) {
        const newLogs = [...(localState.logs || []), msg];
        if (newLogs.length > 10) newLogs.shift();
        db.ref(roomPath + '/logs').set(newLogs);
    }

    function setupDropdowns() {
        const s = document.getElementById('guess-suspect');
        const w = document.getElementById('guess-weapon');
        if (s.options.length > 0) return;
        gameData.suspects.forEach(i => s.innerHTML += `<option>${i}</option>`);
        gameData.weapons.forEach(i => w.innerHTML += `<option>${i}</option>`);
    }

    function makeAccusation() {
        const pos = localState.positions[myChar];
        const r = roomZones.find(z => pos.x >= z.x1 && pos.x <= z.x2 && pos.y >= z.y1 && pos.y <= z.y2)?.name;
        if (!r) return alert("Must be in a room!");
        const s = document.getElementById('guess-suspect').value;
        const w = document.getElementById('guess-weapon').value;
        if (s === localState.solution.suspect && w === localState.solution.weapon && r === localState.solution.room) {
            alert("WINNER!"); db.ref(roomPath).update({ started: false, logs: [`${myChar} WON!`] });
        } else {
            alert("WRONG! Eliminated.");
            db.ref(roomPath + '/players/' + myChar + '/eliminated').set(true);
            endTurn();
        }
    }
</script>
</body>
</html>


